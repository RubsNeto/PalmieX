{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/imprimir.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="pedido-imprimir">
  <h1>Cliente: {{ pedido.cliente }}</h1>
  <div class="detalhes-pedido">
    <p><strong>Vendedor:</strong> {{ pedido.vendedor.nome }}</p>
    <p><strong>Código:</strong> {{ pedido.id }}</p>
    <p><strong>Data:</strong> {{ pedido.data|date:"d/m/Y-H:i" }}</p>
    <p><strong>Loja:</strong> {{ pedido.vendedor.loja }}</p>
    <p><strong>Total Geral:</strong> <span id="total-geral">0</span></p>
  </div>

  <hr>
  {% regroup pedido.itens.all by produto as itens_por_produto %}

  {% for grupo in itens_por_produto %}
    <div class="pedido-item">
      <div class="pedidos">
          <span class="campo"><b>Ref. Balancinho:</b> {{ grupo.list.0.ref_balancinho }}</span>
          <span class="campo"><b>Mat. Balancinho:</b> {{ grupo.list.0.mat_balancinho }}</span>
          <span class="campo"><b>Ref. Palmilha:</b> {{ grupo.list.0.ref_palmilha }}</span>
          <span class="campo"><b>Mat. Palmilha:</b> {{ grupo.list.0.mat_palmilha }}</span>

          <span class="campo"><b>Serviço:</b> {{ grupo.list.0.tipo_servico }}</span>
          <span class="campo"><b>Sintético:</b> {{ grupo.list.0.sintetico }}</span>
          <span class="campo"><b>Cor:</b> {{ grupo.list.0.cor }}</span>
          <span class="campo"><b>Obs:</b> {{ grupo.list.0.obs }}</span>        
      </div>

      <div class="container containerQuadradinhos">
        {% for tamanho in tamanhos %}
          <div class="botao-container">
            <button class="botao">{{ tamanho }}</button>
            <div class="numero" contenteditable="false">
              {% for item in grupo.list %}
                {% if item.tamanho == tamanho %}
                  {{ item.quantidade }}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <hr>
  {% endfor %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    let globalTotal = 0;

    document.querySelectorAll(".pedido-item").forEach(function(item) {
      let materialTotal = 0;
      item.querySelectorAll(".numero").forEach(function(numDiv) {
        let qty = parseInt(numDiv.textContent.trim()) || 0;
        materialTotal += qty;
      });
      globalTotal += materialTotal;

      let totalElem = document.createElement("div");
      totalElem.className = "material-total";
      totalElem.style.marginTop = "0.5em";
      totalElem.style.fontWeight = "bold";
      totalElem.textContent = "Total deste material: " + materialTotal;
      item.appendChild(totalElem);
    });

    document.getElementById("total-geral").textContent = globalTotal;
    window.print();
  });
</script>
{% endblock content %}
